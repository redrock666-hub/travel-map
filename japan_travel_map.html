<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±äº¬æ¶¼ç§‹äº«ä¸‰æ¹¯äº”æ—¥éŠåœ°åœ–</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Leaflet Mouse Position æ’ä»¶çš„ CSS æ–‡ä»¶ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-mouse-position/0.4.0/L.Control.MousePosition.css" />
    <style>
        /* è¨­å®šåœ°åœ–å®¹å™¨æ¨£å¼ */
        #map {
            height: 100vh;
            width: 100vw;
            border: 0px solid transparent;
            outline: none;
            position: relative;
        }
        /* è‡ªè¨‚å½ˆå‡ºè¦–çª—æ¨£å¼ */
        .custom-popup .leaflet-popup-content-wrapper {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .custom-popup .leaflet-popup-content {
            margin: 10px;
        }
        .custom-popup .leaflet-popup-header {
            font-size: 1.2em;
            color: #0078d7;
            margin-bottom: 5px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .custom-popup .scene-note-content {
            font-size: 15px; 
            line-height: 1.6;
            color: #333;
            margin-bottom: 8px;
        }
        .custom-popup .itinerary-content {
            font-size: 14px; 
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
        }
        .leaflet-control-container .leaflet-top,
        .leaflet-control-container .leaflet-bottom { z-index: 1000; }
        .leaflet-control-zoom { margin-top: 10px; }
        .leaflet-control-scale { margin-bottom: 10px; }
        .leaflet-control-mouseposition { margin-left: 10px; }

        /* æ¨™è¨˜æ¨£å¼ */
        .my-div-icon {
            border-radius: 50%;
            color: #fff;
            font-size: 60px;
            width: 70px;
            height: 70px;
            line-height: 70px;
            text-align: center;
            border: 3px solid #fff;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .my-div-icon:hover { transform: scale(1.4); box-shadow: 0 0 30px rgba(0,0,0,0.9); }
        .my-div-icon span { color: #00ffff; }
        .my-div-icon .emoji-label { font-size: 35px; line-height: 70px; text-shadow: none; }

        /* æ—¥åˆ¥é¡è‰² */
        .day-1-icon { background-color: #2e8b57; }
        .day-2-icon { background-color: #d62828; }
        .day-3-icon { background-color: #f77f00; }
        .day-4-icon { background-color: #fcbf49; }
        .day-5-icon { background-color: #555555; }

        /* å°èˆªæŒ‰éˆ• */
        .nav-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 20px;
            background: rgba(0, 120, 215, 0.9);
            padding: 10px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .nav-controls button {
            border: none; padding: 10px 15px; border-radius: 10px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .nav-controls .scene-button {
            background-color: #fff; color: #0078d7;
            width: 50px; height: 50px; padding: 0; line-height: 50px; font-size: 24px;
        }
        .nav-controls .scene-button:hover { background-color: #e6e6e6; color: #005bb5; }
        .nav-controls .all-button {
            background-color: #ffd700; color: #333;
            width: 50px; height: 50px; line-height: 30px; font-size: 18px;
        }
        .nav-controls .all-button:hover { background-color: #e5c500; color: #000; }
        .nav-controls button:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- å°èˆªæ§åˆ¶é … -->
    <div class="nav-controls">
        <button id="prev-scene-button" class="scene-button" title="ä¸Šä¸€å€‹æ™¯é»">&#9664;</button>
        <button id="show-all-button" class="all-button" title="é¡¯ç¤ºæ‰€æœ‰æ™¯é»">å…¨</button>
        <button id="next-scene-button" class="scene-button" title="ä¸‹ä¸€å€‹æ™¯é»">&#9654;</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Leaflet Mouse Position æ’ä»¶çš„ JS æ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-mouse-position/0.4.0/L.Control.MousePosition.min.js"></script>
    <script>
        // åˆå§‹åŒ–åœ°åœ–
        var map = L.map('map').setView([35.6895, 139.6917], 7);

        // === å¯èª¿æ•´ï¼šåº•éƒ¨å®‰å…¨è·é›¢ï¼ˆåƒç´ ï¼‰ ===
        // è¶Šå¤§ -> æ™¯é»è¶Šé ä¸Šï¼ˆé›¢åº•éƒ¨æ§åˆ¶åˆ—æ›´é ï¼‰
        const BOTTOM_SAFE_MARGIN = 200;

        // åœ–ç£š
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // å®Œæ•´çš„è¡Œç¨‹è³‡è¨Š
        const fullItineraries = {
            1: `ğŸ—“ ç¬¬ 1 å¤©ï½œ11/12ï¼ˆä¸‰ï¼‰ æ¡ƒåœ’ âœˆ æˆç”° â†’ æ±äº¬æ¹¯æ¨‚åŸ<br>â—æ—©ä¸Šï¼šé›†åˆæ–¼æ¡ƒåœ’æ©Ÿå ´ï¼Œå°ˆäººè¾¦ç†ç™»æ©Ÿæ‰‹çºŒ<br>â—ä¸­åˆï¼šåœ‹æ³° CX450 (12:50 â†’ 16:50)ï¼Œæ©Ÿä¸Šäº«ç”¨å¥—é¤<br>â—ä¸‹åˆï¼šæŠµé”æˆç”° â†’ ã€æ±äº¬æ¹¯æ¨‚åŸã€‘æº«æ³‰ä¸»é¡Œæ¨‚åœ’ï¼ˆå²©ç›¤æµ´ã€è¡—æ™¯ã€è²å…‰ç§€ï¼‰<br>â—æ™šä¸Šï¼šåœ’å€è‡ªç”±è¦“é£Ÿï¼ˆè‡ªç†ï¼‰ â†’ å…¥ä½æ¹¯æ¨‚åŸåœ‹éš›æ¸¡å‡é…’åº—`,
            2: `ğŸ—“ ç¬¬ 2 å¤©ï½œ11/13ï¼ˆå››ï¼‰ æ±Ÿä¹‹å³¶é›»è»Š â†’ éŒå€‰é«˜æ ¡å‰ â†’ ç®±æ ¹ç¥ç¤¾ â†’ æ–°å€‰å±±æ·ºé–“å…¬åœ’<br>â—æ—©ä¸Šï¼šé£¯åº—æ—©é¤ â†’ æ¹˜å—æµ·å²¸ã€æ±Ÿä¹‹å³¶é›»è»Šé«”é©—ã€‘ã€éŒå€‰é«˜æ ¡å‰ï¼ˆçŒç±ƒé«˜æ‰‹æ‰“å¡ï¼‰<br>â—ä¸­åˆï¼šäº«ç”¨æ—¥å¼é¢¨å‘³å¾¡è†³<br>â—ä¸‹åˆï¼šç®±æ ¹ç¥ç¤¾æ°´ä¸Šé³¥å±… â†’ æ–°å€‰å±±æ·ºé–“å…¬åœ’äº”é‡å¡”ï¼Œæ¬£è³å¯Œå£«å±±çµ•æ™¯<br>â—æ™šä¸Šï¼šå…¥ä½å¯Œå£«äº”æ¹–/æ²³å£æ¹–æº«æ³‰é£¯åº—ï¼Œäº«ç™¾åŒ¯è‡ªåŠ©æˆ–è¿è³“æº«æ³‰æœƒå¸­æ–™ç†`,
            3: `ğŸ—“ ç¬¬ 3 å¤©ï½œ11/14ï¼ˆäº”ï¼‰ æ¸…é‡Œé«˜åŸ â†’ èŒæœ¨ä¹‹æ‘ â†’ è¼•äº•æ¾¤<br>â—æ—©ä¸Šï¼šé£¯åº—æ—©é¤ â†’ æ¸…é‡Œé«˜åŸ â†’ æ¸…æ³‰å¯®ï¼ˆè´ˆç‰›å¥¶å†°æ·‡æ·‹ã€è¶³æ¹¯ï¼‰<br>â—ä¸­åˆï¼šäº«ç”¨è¼•äº•æ¾¤é‡œé£¯å®šé£Ÿæˆ–æ—¥å¼é¤<br>â—ä¸‹åˆï¼šã€èŒæœ¨ä¹‹æ‘ã€‘ç«¥è©±æ£®æ— â†’ è¼•äº•æ¾¤éŠ€åº§é€š â†’ è–ä¿ç¾…æ•™å ‚<br>â—æ™šä¸Šï¼šå…¥ä½è¼•äº•æ¾¤æº«æ³‰é£¯åº—ï¼Œäº«ç™¾åŒ¯è‡ªåŠ©æˆ–è¿è³“æº«æ³‰æœƒå¸­æ–™ç†`,
            4: `ğŸ—“ ç¬¬ 4 å¤©ï½œ11/15ï¼ˆå…­ï¼‰ ç™½çµ²ç€‘å¸ƒ â†’ å·è¶Šå°æ±Ÿæˆ¶ â†’ å°å ´<br>â—æ—©ä¸Šï¼šé£¯åº—æ—©é¤ â†’ ã€ç™½çµ²ç€‘å¸ƒã€‘è¼•äº•æ¾¤ç§˜å¢ƒ<br>â—ä¸­åˆï¼šã€å·è¶Šå°æ±Ÿæˆ¶ã€‘æ™‚ä¹‹é˜ã€è“å­å±‹æ©«ä¸ â†’ åˆé¤æ—¥å¼å¥—é¤<br>â—ä¸‹åˆï¼šå…ç¨…åº— â†’ ã€å°å ´è³¼ç‰©å»£å ´ã€‘è‡ªç”±è³¼ç‰©<br>â—æ™šä¸Šï¼šè‡ªç”±è¦“é£Ÿï¼ˆè‡ªç†ï¼‰ â†’ å…¥ä½æ±äº¬ç£æˆ–å¸‚å€é£¯åº—`,
            5: `ğŸ—“ ç¬¬ 5 å¤©ï½œ11/16ï¼ˆæ—¥ï¼‰ Outlet â†’ æˆç”° âœˆ æ¡ƒåœ’<br>â—æ—©ä¸Šï¼šé£¯åº—æ—©é¤ â†’ ã€MITSUI OUTLET å¹•å¼µã€‘æˆ–ã€é…’é…’äº• PREMIUM OUTLETSã€‘è³¼ç‰©<br>â—ä¸­åˆï¼šè‡ªç”±ç”¨é¤ï¼ˆè‡ªç†ï¼‰<br>â—ä¸‹åˆï¼šå‰å¾€æˆç”°æ©Ÿå ´ â†’ åœ‹æ³° CX451 (15:20 â†’ 18:40)<br>â—æ™šä¸Šï¼šæŠµé”æ¡ƒåœ’ï¼Œè¿”å›æº«æš–çš„å®¶`
        };

        // è¡Œç¨‹è³‡æ–™
        const itinerary = [
            { title: "æŠµé”æ±äº¬æˆç”°æ©Ÿå ´ï¼ˆNRTï¼‰", coords: [35.764722, 140.386389], note: "è¾¦ç†ç™»æ©Ÿæ‰‹çºŒï¼Œæ­ä¹˜åœ‹æ³° CX450 (12:50 â†’ 16:50)æŠµé”æ—¥æœ¬ã€‚", label: "âœˆï¸", day: 1 },
            { title: "æ±äº¬æ¹¯æ¨‚åŸ", coords: [35.7925, 140.297], note: "æŠµé”æˆç”°å¾Œå°ˆè»Šå‰å¾€ã€‚æº«æ³‰ä¸»é¡Œæ¨‚åœ’ï¼ˆå²©ç›¤æµ´ã€è¡—æ™¯ã€è²å…‰ç§€ï¼‰ï¼Œä¸¦å…¥ä½æ¹¯æ¨‚åŸåœ‹éš›æ¸¡å‡é…’åº—ã€‚", label: "1", day: 1 },
            { title: "éŒå€‰é«˜æ ¡å‰", coords: [35.305717, 139.485124], note: "é«”é©—æ¹˜å—æµ·å²¸ã€æ±Ÿä¹‹å³¶é›»è»Šé«”é©—ã€‘ã€éŒå€‰é«˜æ ¡å‰ï¼ˆçŒç±ƒé«˜æ‰‹æ‰“å¡ï¼‰ã€‚", label: "2", day: 2 },
            { title: "ç®±æ ¹ç¥ç¤¾", coords: [35.205739, 139.027061], note: "æ¬£è³ç®±æ ¹ç¥ç¤¾æ°´ä¸Šé³¥å±…ï¼Œæ¢è¨ªæ­·å²å¤å‰ã€‚", label: "3", day: 2 },
            { title: "æ–°å€‰å±±æ·ºé–“å…¬åœ’", coords: [35.50348, 138.80211], note: "æ–°å€‰å±±æ·ºé–“å…¬åœ’äº”é‡å¡”ï¼Œæ¬£è³å¯Œå£«å±±çµ•æ™¯ã€‚æ™šä¸Šå…¥ä½å¯Œå£«äº”æ¹–/æ²³å£æ¹–æº«æ³‰é£¯åº—ã€‚", label: "4", day: 2 },
            { title: "æ¸…é‡Œé«˜åŸèˆ‡æ¸…æ³‰å¯®", coords: [35.9189, 138.4414], note: "æŠµé”æ¸…é‡Œé«˜åŸï¼Œå‰å¾€æ¸…æ³‰å¯®ï¼ˆè´ˆé€ç‰›å¥¶å†°æ·‡æ·‹ã€è¶³æ¹¯ï¼‰ã€‚", label: "5", day: 3 },
            { title: "èŒæœ¨ä¹‹æ‘", coords: [35.908, 138.432], note: "å‰å¾€ã€èŒæœ¨ä¹‹æ‘ã€‘ç«¥è©±æ£®æ—ï¼Œäº«å—æ‚ é–’æ™‚å…‰ã€‚", label: "6", day: 3 },
            { title: "è¼•äº•æ¾¤èˆŠéŠ€åº§é€šèˆ‡è–ä¿ç¾…æ•™å ‚", coords: [36.3533, 138.6366], note: "é€›è¼•äº•æ¾¤éŠ€åº§é€šï¼Œä¸¦åƒè§€è–ä¿ç¾…æ•™å ‚ã€‚æ™šä¸Šå…¥ä½è¼•äº•æ¾¤æº«æ³‰é£¯åº—ã€‚", label: "7", day: 3 },
            { title: "ç™½çµ²ç€‘å¸ƒ", coords: [36.3779, 138.5463], note: "æ¢ç´¢è¼•äº•æ¾¤ç§˜å¢ƒã€ç™½çµ²ç€‘å¸ƒã€‘ã€‚", label: "8", day: 4 },
            { title: "å·è¶Šå°æ±Ÿæˆ¶æ‡·å¤è¡—é“", coords: [35.9242, 139.4828], note: "å‰å¾€ã€å·è¶Šå°æ±Ÿæˆ¶ã€‘æ‡·å¤è¡—é“ï¼Œåƒè§€æ™‚ä¹‹é˜ã€è“å­å±‹æ©«ä¸ã€‚", label: "9", day: 4 },
            { title: "å°å ´è³¼ç‰©å»£å ´", coords: [35.6253, 139.7797], note: "ä¸‹åˆå‰å¾€å…ç¨…åº—ï¼Œä¹‹å¾Œå‰å¾€ã€å°å ´è³¼ç‰©å»£å ´ã€‘è‡ªç”±è³¼ç‰©ã€‚æ™šä¸Šå…¥ä½æ±äº¬ç£æˆ–å¸‚å€é£¯åº—ã€‚", label: "10", day: 4 },
            { title: "é…’é…’äº•PREMIUM OUTLETS", coords: [35.7538, 140.2796], note: "æ—©ä¸Šåœ¨ã€MITSUI OUTLET å¹•å¼µã€‘æˆ–ã€é…’é…’äº• PREMIUM OUTLETSã€‘äº«å—è³¼ç‰©æ¨‚è¶£ã€‚", label: "11", day: 5 },
            { title: "é›¢é–‹æ±äº¬æˆç”°æ©Ÿå ´ï¼ˆNRTï¼‰", coords: [35.764722, 140.386389], note: "ä¸‹åˆå‰å¾€æˆç”°æ©Ÿå ´ï¼Œæ­ä¹˜åœ‹æ³° CX451 (15:20 â†’ 18:40)è¿”å›æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ã€‚", label: "âœˆï¸", day: 5 }
        ];

        // é¡è‰²æ˜ å°„
        const dayColors = { 1:'#2e8b57', 2:'#d62828', 3:'#f77f00', 4:'#fcbf49', 5:'#555555' };

        // ç‹€æ…‹
        let currentItineraryIndex = 0;
        let markers = [];
        let bounds;

        /**
         * è®“æŒ‡å®šåº§æ¨™åœ¨é¡é ­ä¸­è½åœ¨ã€Œè¢å¹•ä¸‹æ–¹ã€è·åº•éƒ¨ marginBottom åƒç´ ã€çš„ä½ç½®
         */
        function flyToPinNearBottom(latlng, zoom = 12, marginBottom = BOTTOM_SAFE_MARGIN) {
            const size = map.getSize();
            const point = map.project(latlng, zoom);
            const offset = L.point(0, (size.y / 2) - marginBottom);
            const targetPoint = point.subtract(offset);
            const targetLatLng = map.unproject(targetPoint, zoom);
            map.flyTo(targetLatLng, zoom, { animate: true, duration: 0.8 });
        }

        /**
         * æ›´æ–°å ´æ™¯é¡¯ç¤º
         */
        function updateSceneDisplay(index) {
            const total = itinerary.length;
            if (index < 0) index = total - 1;
            if (index >= total) index = 0;

            currentItineraryIndex = index;
            if (!markers[currentItineraryIndex]) {
                console.error("Marker not found at index:", currentItineraryIndex);
                return;
            }

            const item = itinerary[currentItineraryIndex];
            const marker = markers[currentItineraryIndex];

            // è®“é»é ä¸‹ï¼ˆç•™ 200px å®‰å…¨è·é›¢ï¼‰
            flyToPinNearBottom(item.coords, 12);

            map.closePopup();
            marker.openPopup();
        }

        function nextScene() { updateSceneDisplay(currentItineraryIndex + 1); }
        function prevScene() { updateSceneDisplay(currentItineraryIndex - 1); }

        /**
         * é¡¯ç¤ºæ‰€æœ‰æ™¯é»ï¼ˆå…¨è¦½æ™‚ä¹Ÿç•™å‡ºåº•éƒ¨ç©ºé–“ï¼‰
         */
        function showAllScenes() {
            map.closePopup();
            map.fitBounds(bounds, {
                paddingTopLeft: [50, 50],
                paddingBottomRight: [50, BOTTOM_SAFE_MARGIN + 20] // 220px
            });
        }

        // å»ºç«‹æ¨™è¨˜èˆ‡è·¯ç·š
        let polylinePoints = [];
        itinerary.forEach(function(item, index) {
            const popupContent = `
            <div class="custom-popup">
                <h2 class="leaflet-popup-header">ç¬¬ ${item.day} å¤©ï¼š${item.title}</h2>
                ${item.note ? `<p class="scene-note-content"><b>æ™¯é»å‚™è¨»ï¼š</b> ${item.note}</p><hr>` : ''}
                <p class="itinerary-content"><b>ç•¶æ—¥å®Œæ•´è¡Œç¨‹ï¼š</b><br>${fullItineraries[item.day]}</p>
            </div>`;
            const isEmoji = isNaN(item.label);
            const labelClass = isEmoji ? 'emoji-label' : '';

            const marker = L.marker(item.coords, {
                icon: L.divIcon({
                    className: `my-div-icon day-${item.day}-icon`,
                    html: `<span class="${labelClass}">${item.label}</span>`
                })
            }).bindPopup(popupContent).addTo(map);

            markers.push(marker);
            polylinePoints.push({ coords: item.coords, day: item.day });

            marker.on('click', function() { updateSceneDisplay(index); });
        });

        // å¤šè‰²è·¯ç·š
        let currentDayPoints = [];
        for (let i = 0; i < polylinePoints.length; i++) {
            currentDayPoints.push(polylinePoints[i].coords);
            if (i < polylinePoints.length - 1 && polylinePoints[i].day !== polylinePoints[i+1].day) {
                L.polyline(currentDayPoints, { color: dayColors[polylinePoints[i].day], weight: 5 }).addTo(map);
                currentDayPoints = [polylinePoints[i].coords];
            }
        }
        L.polyline(currentDayPoints, { color: dayColors[polylinePoints[polylinePoints.length-1].day], weight: 5 }).addTo(map);

        // å…¨è¦½é‚Šç•Œï¼ˆåˆå§‹ä¹Ÿç•™åº•éƒ¨ç©ºé–“ï¼‰
        bounds = L.latLngBounds(polylinePoints.map(p => p.coords));
        map.fitBounds(bounds, {
            paddingTopLeft: [50, 50],
            paddingBottomRight: [50, BOTTOM_SAFE_MARGIN + 20] // 220px
        });

        // æ§åˆ¶é …èˆ‡äº‹ä»¶
        window.onload = function() {
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.control.scale({ imperial: false }).addTo(map);

            if (typeof L.control.mousePosition === 'function') {
                L.control.mousePosition({ position: 'bottomleft', separator: 'ï¼Œ', prefix: 'åº§æ¨™ï¼š' }).addTo(map);
            } else {
                console.warn("Leaflet MousePosition plugin failed to initialize.");
            }

            document.getElementById('prev-scene-button')?.addEventListener('click', prevScene);
            document.getElementById('next-scene-button')?.addEventListener('click', nextScene);
            document.getElementById('show-all-button')?.addEventListener('click', showAllScenes);

            if (markers.length > 0) updateSceneDisplay(0);
        };
    </script>
</body>
</html>

